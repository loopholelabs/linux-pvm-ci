#!/bin/bash

set -e

# Install native dependencies for Fedora
if [ "$1" = "fedora" ]; then
    sudo dnf group install -y "Development Tools"
    sudo dnf install -y fedora-packager rpmdevtools perl rpm-sign
    sudo dnf builddep -y kernel
fi

# Install native dependencies for Rocky Linux
if [ "$1" = "rocky" ]; then
    dnf group install -y "Development Tools"
    dnf install -y rpmdevtools perl rpm-sign gnupg2
    dnf install -y https://www.elrepo.org/elrepo-release-9.el9.elrepo.noarch.rpm
    dnf config-manager --set-enabled crb
    dnf builddep -y kernel
fi

# Install native dependencies for Alma Linux
if [ "$1" = "alma" ]; then
    dnf group install -y "Development Tools"
    dnf install -y rpmdevtools perl rpm-sign gnupg2
    dnf install -y https://www.elrepo.org/elrepo-release-9.el9.elrepo.noarch.rpm
    dnf config-manager --set-enabled crb
    dnf builddep -y kernel
fi

# Configure Git
git config --global --add safe.directory '*'

# Configure PGP
echo "${PGP_KEY_PASSWORD}" | base64 -d >'/tmp/pgp-pass'
mkdir -p "${HOME}/.gnupg"
cat >"${HOME}/.gnupg/gpg.conf" <<EOT
yes
passphrase-file /tmp/pgp-pass
pinentry-mode loopback
EOT

echo "${PGP_KEY}" | base64 -d >'/tmp/private.pgp'
gpg --import /tmp/private.pgp

echo "%_signature gpg
%_gpg_name $(echo ${PGP_KEY_ID} | base64 -d)" >"${HOME}/.rpmmacros"

# Get kernel source
make clone

# Patch and configure kernel
make "copy/${1}/${2}"
make "patch/${1}/${2}"
make "configure/${1}/${2}"

# Build kernel
make -j$(nproc) "build/${1}/${2}"

# Package kernel
make -j$(nproc) "package/${1}/${2}" PGP_KEY_ID="${PGP_KEY_ID}"
